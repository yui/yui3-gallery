YUI.add("gallery-undo",function(A){(function(){function F(T){F.superclass.constructor.apply(this,arguments);}var G=A.Lang,C="UndoManager",K="actionAdded",J="actionMerged",H="beforeCanceling",Q="actionCanceled",D="cancelingFinished",S="beforeUndo",I="actionUndone",R="undoFinished",N="beforePurge",B="purgeFinished",L="beforeRedo",O="redoFinished",M="actionRedone",E="asyncProcessing",P=0;A.mix(F,{NAME:C,ATTRS:{limit:{value:P,validator:function(T){return G.isNumber(T)&&T>=0;}},undoIndex:{readOnly:true,getter:function(){return this._undoIndex;}}}});A.extend(F,A.Base,{_actions:[],_undoIndex:0,_actionHandle:null,_processing:false,initializer:function(T){this._initEvents();this.after("limitChange",A.bind(this._afterLimit,this));},destructor:function(){this.purgeAll();},_initEvents:function(){this.publish(K);this.publish(J);this.publish(H);this.publish(Q);this.publish(D);this.publish(N);this.publish(B);this.publish(S);this.publish(I);this.publish(R);this.publish(L);this.publish(M);this.publish(O);},add:function(X){var W=null,Y,V,U,T=false;if(this._processing){return false;}Y=this._actions;V=this._undoIndex;if(V>0){W=Y[V-1];}if(V<Y.length){this.fire(H);while(V<Y.length){U=Y.splice(-1,1)[0];U.cancel();this.fire(Q,{action:U,index:Y.length});}this.fire(D);}if(W){T=W.merge(X);if(!T){Y.push(X);}}else{Y.push(X);}if(!T){this._undoIndex++;this._limitActions();this.fire(K,{action:X});}else{this.fire(J,{"action":W,"mergedAction":X});}return true;},_limitActions:function(V){var X,U,c,T,d,a,Z,b,Y,W;if(!V){V=this.get("limit");}if(V===P){return;}X=this._actions;if(X.length<=V){return;}b=this._undoIndex;c=parseInt(V/2,10);T=V-c;d=V-T;a=b-T;Z=X.length-b-d;if(a<0){Z+=a;}else{if(Z<0){a+=Z;}}if(a>0||Z>0){this.fire(H);for(Y=0;Y<a;Y++){this._undoIndex--;U=X.splice(0,1)[0];U.cancel();this.fire(Q,{"action":U,index:0});}for(Y=X.length-1,W=0;W<Z;Y--,W++){U=X.splice(Y,1)[0];U.cancel();this.fire(Q,{"action":U,index:Y});}this.fire(D);}},_afterLimit:function(T){this._limitActions(T.newVal);},undo:function(){if(this.canUndo()){this._undoTo(this._undoIndex-1);}},redo:function(){if(this.canRedo()){this._redoTo(this._undoIndex+1);}},canUndo:function(){return !this._processing&&this._undoIndex>0;},canRedo:function(){return !this._processing&&this._undoIndex<this._actions.length;},getUndoLabel:function(){var T;if(this.canUndo()){T=this._actions[this._undoIndex-1];return T.get("label");}return null;},getRedoLabel:function(){var T;if(this.canRedo()){T=this._actions[this._undoIndex];return T.get("label");}return null;},purgeAll:function(){this.purgeTo(0);},purgeTo:function(T){var V,U=this._actions.length-1;if(U>=T){this.fire(N);for(;U>=T;U--){V=this._actions.splice(U,1)[0];V.cancel();this.fire(Q,{"action":V,index:U});}if(this._undoIndex>T){this._undoIndex=T;}this._processing=false;this.fire(B);}},processTo:function(T){if(G.isNumber(T)&&!this._processing&&T>=0&&T<=this._actions.length){if(this._undoIndex<T){this._redoTo(T);}else{if(this._undoIndex>T){this._undoTo(T);}}}},_redoTo:function(T){var U=this._actions[this._undoIndex++];if(!this._processing){this.fire(L);this._processing=true;}if(!U.get(E)){U.redo();this.fire(M,{"action":U,index:this._undoIndex-1});if(this._undoIndex<T){this._redoTo(T);}else{this._processing=false;this.fire(O);}}else{this._actionHandle=U.on(O,A.bind(this._onAsyncRedoFinished,this,U,T));U.redo();}},_undoTo:function(T){var U=this._actions[--this._undoIndex];if(!this._processing){this.fire(S);this._processing=true;}if(!U.get(E)){U.undo();this.fire(I,{"action":U,index:this._undoIndex});if(this._undoIndex>T){this._undoTo(T);}else{this._processing=false;this.fire(R);}}else{this._actionHandle=U.on(R,A.bind(this._onAsyncUndoFinished,this,U,T));U.undo();}},_onAsyncUndoFinished:function(U,T){this._actionHandle.detach();this._actionHandle=null;this.fire(I,{"action":U,index:this._undoIndex});if(this._undoIndex>T){this._undoTo(T);}else{this._processing=false;this.fire(R,{"action":U});}},_onAsyncRedoFinished:function(U,T){this._actionHandle.detach();this._actionHandle=null;this.fire(M,{"action":U,index:this._undoIndex-1});if(this._undoIndex<T){this._redoTo(T);}else{this._processing=false;this.fire(O,{"action":U});}}});A.UndoManager=F;}());(function(){function H(J){H.superclass.constructor.apply(this,arguments);}var G=A.Lang,I="UndoableAction",C="label",E="beforeUndo",B="undoFinished",F="beforeRedo",D="redoFinished";A.mix(H,{NAME:I,ATTRS:{label:{value:"",validator:G.isString},asyncProcessing:{value:false,validator:G.isBoolean}}});A.extend(H,A.Base,{_childActions:[],initializer:function(J){this._initEvents();},destructor:function(){},_initEvents:function(){this.publish(E);this.publish(B);this.publish(F);this.publish(D);},undo:function(){var L,K,J;this.fire(E);L=this._childActions;for(J=L.length-1;J>0;J--){K=L[J];K.undo();}this.fire(B);},redo:function(){var M,L,J,K;this.fire(F);M=this._childActions;K=M.length;for(J=0;J<K;J++){L=M[J];L.redo();}this.fire(D);},merge:function(J){return false;},cancel:function(){},toString:function(){return this.get(C);}});A.UndoableAction=H;}());},"gallery-2010.04.08-12-35",{requires:["base","event"]});