YUI.add("gallery-querybuilder",function(G){var B=(0<G.UA.ie&&G.UA.ie<9);function F(J,I,K){if(arguments.length===0){return;}if(!G.FormManager){G.FormManager={row_marker_class:"",status_marker_class:"",required_class:""};}this.var_list=J.slice(0);this.op_list=G.clone(I);this.op_list.none=[];this.row_list=[];F.superclass.constructor.call(this,K);}F.NAME="querybuilder";F.ATTRS={chooseVarPrompt:{value:"Choose a Variable",validator:G.Lang.isString,writeOnce:true},fieldPrefix:{value:"",validator:G.Lang.isString,writeOnce:true},pluginConfig:{value:{},validator:G.Lang.isObject,writeOnce:true}};function D(){this.var_list.unshift({name:"yui3-querybuilder-choose-prompt",type:"none",text:this.get("chooseVarPrompt")});}function A(K,L){var J=K.length;for(var I=0;I<J;I++){if(K[I].row==L){return I;}}return -1;}function C(J,I){this.appendNew();}function E(K,J){var I=A(this.row_list,J);if(I>=0){this.remove(I);}}function H(K,J){var I=A(this.row_list,J);if(I>=0){this.update(I);}}G.extend(F,G.Widget,{initializer:function(I){var J=this.get("fieldPrefix");this.var_menu_name_pattern=J+"query_var_{i}";this.get("pluginConfig").fieldPrefix=J;this.plugin_column_count=0;D.call(this);},renderUI:function(){var I=this.get("contentBox");I.on("change",this._notifyChanged,this);I.on("keyup",this._notifyChanged,this);this.table=G.Node.create("<table></table>");I.appendChild(this.table);this.appendNew();},destructor:function(){for(var I=0;I<this.row_list.length;I++){this.row_list[I].plugin.destroy();}this.row_list=null;this.table=null;},reset:function(J,I){this._allow_remove_last_row=true;for(var K=this.row_list.length-1;K>=0;K--){this.remove(K);}this._allow_remove_last_row=false;if(J){this.var_list=J.slice(0);D.call(this);}if(I){this.op_list=G.clone(I);this.op_list.none=[];}this.appendNew();},appendNew:function(L,V){if(L&&this.row_list.length==1){var N=this.row_list[0].var_menu;if(N.get("selectedIndex")===0){for(var Q=0;Q<this.var_list.length;Q++){if(this.var_list[Q].name==L){N.set("selectedIndex",Q);break;}}this.update(0,V);return this.row_list[0].plugin;}}var T=this.row_list.length;var J=G.Node.create("<tbody></tbody>");J.set("className",G.FormManager.row_marker_class);var S=G.Node.create("<tr></tr>");S.set("className",this.getClassName("error"));J.appendChild(S);var K=this._createContainer();K.set("colSpan",1+this.plugin_column_count);K.set("innerHTML",'<p class="'+G.FormManager.status_marker_class+'"></p>');S.appendChild(K);S.appendChild(this._createContainer());var P=G.Node.create("<tr></tr>");P.set("className",this.getClassName("criterion"));J.appendChild(P);var I=this._createContainer();I.set("className",this.getClassName("variable"));P.appendChild(I);I.set("innerHTML",this._variablesMenu(this.variableName(T)));var N=I.one("select");N.on("change",H,this,P);var W=G.Node.getDOMNode(N).options;for(var Q=0;Q<this.var_list.length;Q++){W[Q]=new Option(this.var_list[Q].text,this.var_list[Q].name);if(this.var_list[Q].name==L){N.set("selectedIndex",Q);}}if(B){N.on("change",this._notifyChanged,this);}var R=this._createContainer();R.set("className",this.getClassName("controls"));R.set("innerHTML",this._rowControls());P.appendChild(R);var M=R.one("."+this.getClassName("insert"));if(M){M.on("click",C,this,P);}var U=R.one("."+this.getClassName("remove"));if(U){U.on("click",E,this,P);}this.table.appendChild(J);var O={body:J,row:P,var_menu:N,control:R,error:K};this.row_list.push(O);this.update(T,V);J.scrollIntoView();return this.row_list[T].plugin;},update:function(S,T){var P=this.row_list[S].row;var R=this.row_list[S].control;this.row_list[S].error.one("."+G.FormManager.status_marker_class).set("innerHTML","");if(this.row_list[S].plugin){this.row_list[S].plugin.destroy();this.row_list[S].plugin=null;}while(P.get("children").size()>2){var K=P.get("children").item(0).next();K.remove(true);}var L=this.row_list[S].var_menu;var J=this.var_list[L.get("selectedIndex")];var U=[];if(J.type!="none"){this.row_list[S].plugin=new F.plugin_mapping[J.type](this,this.get("pluginConfig"));U=this.row_list[S].plugin.create(S,J,this.op_list[J.type],T);}while(U.length<this.plugin_column_count){U.push(this._createContainer());}for(var O=0;O<U.length;O++){P.insertBefore(U[O],R);}if(U.length>this.plugin_column_count){var I=1+U.length;for(var O=0;O<this.row_list.length;O++){var V=this.row_list[O].row;this.row_list[O].error.set("colSpan",I);if(V!=P){var N=this.row_list[O].control;for(var M=this.plugin_column_count;M<U.length;M++){V.insertBefore(this._createContainer(),N);}}}this.plugin_column_count=U.length;}var Q=this.row_list[S].plugin;if(Q&&G.Lang.isFunction(Q.postCreate)){this.row_list[S].plugin.postCreate(S,J,this.op_list[J.type],T);}},remove:function(K){if(this.row_list.length<=0){return false;}if(!this._allow_remove_last_row&&this.row_list.length==1){var J=this.row_list[0].var_menu;J.set("selectedIndex",0);this.update(0);this.fire("queryChanged",{remove:true});return true;}var M=this.row_list[K].body;if(M===null){return false;}if(this.row_list[K].plugin){this.row_list[K].plugin.destroy();}M.remove(true);this.row_list.splice(K,1);for(var I=0;I<this.row_list.length;I++){var J=this.row_list[I].var_menu;J.setAttribute("name",this.variableName(I));var L=this.var_list[J.get("selectedIndex")];if(L.type!="none"){this.row_list[I].plugin.updateName(I);}}this.fire("queryChanged",{remove:true});return true;},getPlugin:function(I){return this.row_list[I].plugin;},toDatabaseQuery:function(){var I=[];for(var K=0;K<this.row_list.length;K++){var N=this.row_list[K];var L=N.plugin;if(L){var M=L.toDatabaseQuery();for(var J=0;J<M.length;J++){I.push([N.var_menu.get("value")].concat(M[J]));}}}return I;},_createContainer:function(){return G.Node.create("<td></td>");},_notifyChanged:function(){this.fire("queryChanged");},variableName:function(I){return G.Lang.substitute(this.var_menu_name_pattern,{i:I});},_variablesMenu:function(J){var I='<select name="{n}" class="formmgr-field {c}" />';return G.Lang.substitute(I,{n:J,c:this.getClassName("field")});},_rowControls:function(){var I='<span class="{ci}"></span>'+'<span class="{cr}"></span>';
if(!this._controls_markup){this._controls_markup=G.Lang.substitute(I,{ci:this.getClassName("insert"),cr:this.getClassName("remove")});}return this._controls_markup;}});G.QueryBuilder=F;F.String=function(J,I){this.qb=J;this.op_menu_name_pattern=I.field_prefix+"query_op_{i}";this.val_input_name_pattern=I.field_prefix+"query_val_{i}";};F.String.prototype={create:function(N,M,I,O){var L=this.qb._createContainer();L.set("className",this.qb.getClassName("operator"));L.set("innerHTML",this._operationsMenu(this.operationName(N)));this.op_menu=L.one("select");var J=G.Node.getDOMNode(this.op_menu).options;for(var K=0;K<I.length;K++){J[K]=new Option(I[K].text,I[K].value);}O=O||["",""];if(O[0]){this.op_menu.set("value",O[0]);}if(B){this.op_menu.on("change",this.qb._notifyChanged,this.qb);}var P=this.qb._createContainer();P.set("className",this.qb.getClassName("value"));P.set("innerHTML",this._valueInput(this.valueName(N),M.validation));this.value_input=P.one("input");this.value_input.set("value",O[1]);return[L,P];},destroy:function(){this.op_menu=null;this.value_input=null;},updateName:function(I){this.op_menu.setAttribute("name",this.operationName(I));this.value_input.setAttribute("name",this.valueName(I));},set:function(I,J){this.op_menu.set("value",J[this.operationName(I)]);this.value_input.set("value",J[this.valueName(I)]);},toDatabaseQuery:function(){return[[this.op_menu.get("value"),this.value_input.get("value")]];},operationName:function(I){return G.Lang.substitute(this.op_menu_name_pattern,{i:I});},valueName:function(I){return G.Lang.substitute(this.val_input_name_pattern,{i:I});},_operationsMenu:function(J){var I='<select name="{n}" class="formmgr-field {c}" />';return G.Lang.substitute(I,{n:J,c:this.qb.getClassName("field")});},_valueInput:function(K,J){var I='<input type="text" name="{n}" class="yiv-required formmgr-field {c}"/>';return G.Lang.substitute(I,{n:K,c:J+" "+this.qb.getClassName("field")});}};F.Select=function(J,I){this.qb=J;this.val_input_name_pattern=I.field_prefix+"query_val_{i}";};F.Select.prototype={create:function(N,M,I,O){var P=this.qb._createContainer();P.set("className",this.qb.getClassName("value"));P.set("innerHTML",this._valuesMenu(this.valueName(N)));this.value_menu=P.one("select");var J=G.Node.getDOMNode(this.value_menu).options;var L=M.value_list;for(var K=0;K<L.length;K++){J[K]=new Option(L[K].text,L[K].value);}if(O){this.value_menu.set("value",O);}if(B){this.value_menu.on("change",this.qb._notifyChanged,this.qb);}this.db_query_equals=I[0];return[P];},destroy:function(){this.value_menu=null;},updateName:function(I){this.value_menu.setAttribute("name",this.valueName(I));},set:function(I,J){this.value_menu.set("value",J[this.valueName(I)]);},toDatabaseQuery:function(){return[[this.db_query_equals,this.value_menu.get("value")]];},valueName:function(I){return G.Lang.substitute(this.val_input_name_pattern,{i:I});},_valuesMenu:function(J){var I='<select name="{n}" class="formmgr-field {c}" />';return G.Lang.substitute(I,{n:J,c:this.qb.getClassName("field")});}};F.plugin_mapping={string:F.String,number:F.String,select:F.Select};},"gallery-2010.08.04-19-46",{requires:["widget","substitute"],optional:["gallery-formmgr","gallery-scrollintoview"]});