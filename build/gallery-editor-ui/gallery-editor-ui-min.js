YUI.add("gallery-editor-ui",function(e,t){function n(e){n.superclass.constructor.apply(this,arguments)}function r(e){r.superclass.constructor.apply(this,arguments)}n.NAME="editor-ui",n.ATTRS={textareaEl:{value:null,validator:e.Lang.isString,writeOnce:!0},formEl:{value:null,validator:e.Lang.isString,writeOnce:!0},editorClass:{value:"post",writeOnce:!0},contentStylesheetUrl:{value:"/build/gallery-editor-ui/assets/gallery-editor-ui-content.css",writeOnce:!0},uploadToUrl:{value:"/build/gallery-editor-ui/assets/fake-upload.html",validator:e.Lang.isString,writeOnce:!0},visualEditMode:{value:!0},editor:null,textArea:null,baseEditor:null,frameInstance:null,linkWindow:null,mediaWindow:null,sizeWindow:null,flagPaste:null},e.extend(n,e.Base,{regexps:{divToPElementsRe:/<(a|blockquote|dl|div|ol|p|pre|table|ul|img)/i,replaceBrsRe:/(<br[^>]*>[ \n\r\t]*){2,}/gi,replaceFontsRe:/<(\/?)font[^>]*>/gi,trimRe:/^\s+|\s+$/g,normalizeRe:/\s{2,}/g,killBreaksRe:/(<br\s*\/?>(\s|&nbsp;?)*){1,}/g},tag2cmd:{b:"bold",strong:"bold",i:"italic",em:"italic",u:"underline",blockquote:"blockquote",img:"media",a:"link",ul:"insertunorderedlist",ol:"insertorderedlist",h2:"size",h3:"size"},styles:{textDecoration:!0,fontWeight:!0,fontStyle:!0,textAlign:!0,color:!1,fontSize:!1,fontFamily:!1,backgroundColor:!1},style2tag:{strong:"strong",italic:"em",underline:"em"},textAreaTextDefault:"<p><br><p>",renderUI:function(){},destructor:function(){},initializer:function(){var t,n,r,i;if(this.get("textareaEl")){t=e.one(this.get("textareaEl"));if(!t)return!1;t.addClass("Ak"),n=e.Node.create('<div style="width: '+t.getComputedStyle("width")+'""></div>'),r=e.Node.create('<div class="f9 Ar" style="display: none"></div>'),i=e.Node.create('<div class="f8 Ar"></div>'),t.wrap(r),r.wrap(n),n.appendChild(i),this.set("textArea",t),this.set("editor",n),e.one("body").hasClass("yui3-skin-sam")||e.one("body").addClass("yui3-skin-sam"),this.get("formEl")===null;var s=new e.EditorBase({defaultblock:"p",extracss:"body {margin: 0; padding: 0; overflow-y: scroll; overflow-x: hidden;} img, iframe, object, embed { -webkit-user-select: none; user-select: none; user-select: none;}",linkedcss:this.get("contentStylesheetUrl"),plugins:[e.Plugin.EditorBr,e.Plugin.EditorTab,e.Plugin.EditorLists]});this.set("baseEditor",s),e.mix(s,{editorUI:this}),s.on("frame:ready",function(){this.set("frameInstance",s.getInstance()),this.get("frameInstance").one("body").addClass(this.get("editorClass")).addClass("editing"),this.get("frameInstance").on("resizestart",e.bind(function(){return!1},this)),this._buildToolbar(),this._registerCommands(),this._initToolbar(),this._toggleComposer(!0)},this),this.set("linkWindow",new e.Panel({modal:!0,visible:!1,centered:!0,zIndex:150,shim:!0,headerContent:"Add Link",bodyContent:'<table class="space"><tr><td>Text to display:</td><td><input id="linkdialog-text" style="width: 300px"></td></tr><tr><td>To what URL should this link go?</td><td><input id="linkdialog-input" type="url" style="width: 300px; margin-right: 5px;"><small><a href="#" id="testLink" target="_blank">test link</a></small></td></tr><tr><td colspan="2"><div class="Kj-JD-Jl"><button name="ok" id="linkSubmitButton">Insert Link</button><button name="cancel" class="linkHideWindow">Cancel</button></div></td></tr></table>',render:!0})),this.set("mediaWindow",new e.Panel({modal:!0,visible:!1,centered:!0,zIndex:150,shim:!0,headerContent:"Add Media",bodyContent:'<table class="space"><tr><td colspan="2"><div class="image-upload-frame"></div></td></tr><tr><td>URL:</td><td><input id="mediadialog-source" style="width: 300px" placeholder="http://"></td></tr><tr><td>Title:</td><td><input id="mediadialog-text" style="width: 300px" placeholder=""></td></tr><tr><td colspan="2"><div class="Kj-JD-Jl"><button name="ok" id="mediaSubmitButton">Add Media</button><button name="cancel" class="mediaHideWindow">Cancel</button></div></td></tr></table>',render:!0})),this.set("sizeWindow",new e.Overlay({visible:!1,zIndex:150,shim:!0,bodyContent:'<div class="J-M"><div class="J-N" role="menuitem" style="font-size: normal;" command="p">Paragraph</div><div class="J-N" role="menuitem" style="font-size: x-large;" command="h2">Header One</div><div class="J-N" role="menuitem" style="font-size: large;" command="h3">Header Two</div><div class="J-N" role="menuitem" style="font-size: 1.2em" command="h3">Header Three</div></div>',align:{node:".eY",points:[e.WidgetPositionAlign.TL,e.WidgetPositionAlign.BL]},render:!0})),e.one(".mediaHideWindow").on("click",e.bind(function(){this.get("mediaWindow").hide()},this)),e.one(".linkHideWindow").on("click",e.bind(function(){this.get("linkWindow").hide()},this)),s.render(i)}},_registerCommands:function(){e.mix(e.Plugin.ExecCommand.COMMANDS,{bold:function(e){var t=this.get("host").getInstance(),n=new t.Selection,r,i="",s=t.host.editorUI;if(n&&n.anchorNode.get("tagName")==="STRONG")n.isCollapsed?this._command("bold"):this._command("bold");else{if(n&&n.anchorNode.get("tagName")==="BODY")return;n&&(n.isCollapsed?(i=s._getInnerText(n.anchorNode),i.length>0?r=n.insertContent("<strong>&nbsp;</strong>"):r=n.insertContent("<strong>&nbsp;</strong><br>"),n.focusCursor(!0,!0)):(r=n.wrapContent("strong"),n.focusCursor(!0,!0)))}return r},italic:function(e){var t=this.get("host").getInstance(),n=new t.Selection,r,i="",s=t.host.editorUI;if(n&&n.anchorNode.get("tagName")==="EM")n.isCollapsed?this._command("italic"):this._command("italic");else{if(n&&n.anchorNode.get("tagName")==="BODY")return;n&&(n.isCollapsed?(i=s._getInnerText(n.anchorNode),i.length>0?r=n.insertContent("<em>&nbsp;</em>"):r=n.insertContent("<em>&nbsp;</em><br>"),n.focusCursor(!0,!0)):(r=n.wrapContent("em"),n.focusCursor(!0,!0)))}return r},size:function(e,t){var n=this.get("host").getInstance(),r=new n.Selection,t,i="",s=n.host.editorUI;(!r||!r.isCollapsed)&&(!t||!t.get("tagName"))&&r&&r.anchorNode.get("tagName")==="P",r.focusCursor(!0,!0),s.get("sizeWindow").get("visible")===!0?s.get("sizeWindow").setAttrs({visible:!1}):s.get("sizeWindow"
).setAttrs({visible:!0})},media:function(t,n){var r=this.get("host").getInstance(),i=new r.Selection,n,s,o="",u="http://",a=r.host.editorUI;if(n&&n.changedType==="mouseup"&&!i.isCollapsed)return!1;i&&i.anchorNode&&i.anchorNode.get("tagName")==="IMG"?(n=i.anchorNode,o=n.get("title"),u=n.get("src")):n&&n.get("tagName")==="IMG"?(o=n.get("title"),u=n.get("src")):i?i.isCollapsed||(o=i.text):r.focus();var f=a.get("mediaWindow").get("contentBox").one(".image-upload-frame"),l=a.get("editor").get("offsetWidth"),c={cellImageSizes:{height:"300px",width:l},frameEl:f,resizeHeight:!0,uploadToUrl:this.get("uploadToUrl")};n&&(c=e.mix(c,{file:u,cellImageSizes:{width:n.getStyle("width"),height:n.getStyle("height")}},!0));var h=new e.EditorImageManage(c);h.on("upload:start",e.bind(function(e){},this)),h.on("upload:error",e.bind(function(e){},this)),h.on("upload:complete",e.bind(function(t){var n=e.JSON.parse(t.data);n&&n.status===1&&e.one("#mediadialog-source").set("value",n.file)},this)),e.one("#mediadialog-source").set("value",u),e.one("#mediadialog-text").set("value",o),e.one("#mediaSubmitButton").destroy(),e.one("#mediaSubmitButton").on("click",e.bind(function(t){t.preventDefault(),n?(n.set("src",e.one("#mediadialog-source").get("value")),n.set("title",e.one("#mediadialog-text").get("value"))):this.command("insertandfocus",'<img src="'+e.one("#mediadialog-source").get("value")+'" title="'+e.one("#mediadialog-text").get("value")+'">'+a.textAreaTextDefault),a.get("mediaWindow").hide()},this)),a.get("mediaWindow").setAttrs({visible:!0})},link:function(t,n){var r=this.get("host").getInstance(),i=new r.Selection,n,s="",o="http://",u=r.host.editorUI;if(n&&n.changedType==="mouseup"&&!i.isCollapsed)return!1;i&&i.anchorNode&&i.anchorNode.get("tagName")==="A"?(n=i.anchorNode,s=n.get("text"),o=n.get("href")):n&&n.get("tagName")==="A"?(s=n.get("text"),o=n.get("href")):i?i.isCollapsed||(s=i.text):r.focus(),e.one("#linkdialog-text").set("value",s),e.one("#linkdialog-input").set("value",o),e.one("#testLink").destroy(),e.one("#testLink").on("mousedown",e.bind(function(t){t.preventDefault(),t.currentTarget.set("href",e.one("#linkdialog-input").get("value"))},this)),e.one("#linkSubmitButton").destroy(),e.one("#linkSubmitButton").on("click",e.bind(function(t){t.preventDefault();var r,i;i=e.one("#linkdialog-text").get("value"),r=e.one("#linkdialog-input").get("value"),i.length>0&&r!=="http://"?n?(n.set("href",r),n.set("text",i)):this.command("insertandfocus",'<a href="'+r+'">'+i+"</a>"):this.command("unlink"),u.get("linkWindow").hide()},this)),u.get("linkWindow").setAttrs({visible:!0})},blockquote:function(e){var t=this.get("host").getInstance(),n=new t.Selection,r,i="",s=t.host.editorUI;if(n&&n.anchorNode.get("tagName")==="BLOCKQUOTE")n.isCollapsed?this._command("outdent"):this._command("outdent");else{if(n&&n.anchorNode.get("tagName")==="BODY")return;n?n.isCollapsed?(r=n.insertContent("<blockquote>&nbsp;</blockquote>"),n.focusCursor(!0,!0)):(r=n.wrapContent("blockquote"),n.focusCursor(!0,!0)):this._command("blockquote")}},clear:function(e){var t=this.get("host").getInstance(),n=new t.Selection,r,i=confirm("You will lose the html formatting. Are you sure?");i&&n.anchorNode&&(n.anchorNode.get("parentNode").get("tagName")==="BODY"?n.anchorNode.set("outerHTML","<p>"+n.anchorNode.get("text")+"<br></p>"):(n.anchorNode.set("outerHTML",n.anchorNode.get("text")),n.focusCursor(!0,!0)))}})},_buildToolbar:function(){var t=this.get("editor"),n=e.Node.create('<div class="toolbars"></div>'),r=e.Node.create('<div class="html_toolbar"></div>'),i=e.Node.create('<div class="plain_toolbar" style="display: none"></div>'),s=[{fn:"bold",cls:"eN"},{fn:"italic",cls:"e3"},{fn:"underline",cls:"fu"},{fn:"size",cls:"eY",desc:"Format size",arrow:!0},{fn:"media",cls:"QT",desc:"Insert image"},{fn:"link",cls:"e5",desc:"Insert link"},{fn:"insertorderedlist",cls:"e6",desc:"Ordered list"},{fn:"insertunorderedlist",cls:"eO",desc:"Unordered list"},{fn:"outdent",cls:"e8",desc:"Outdent"},{fn:"indent",cls:"e2",desc:"Indent"},{fn:"blockquote",cls:"fa",desc:"Insert blockquote"},{fn:"justifyleft",cls:"e4",desc:"Align text left"},{fn:"justifycenter",cls:"eP",desc:"Center text"},{fn:"justifyright",cls:"fc",desc:"Align text right"},{fn:"justifyfull",cls:"fd",desc:"Text justified"},{fn:"clear",cls:"fb",desc:"Clear formatting selection"}];e.Object.each(s,function(e){r.appendChild(this._createToolbarButton(e))},this),r.appendChild(e.Node.create('<div class="button switch e9">Edit HTML</div>')),n.appendChild(r),i.appendChild(e.Node.create('<div class="button switch k9">Rich formatting</div>')),i.appendChild(this._createToolbarButton({fn:"format",cls:"u9",desc:"Format HTML"})),n.appendChild(i),t.insert(n,t.one("*"))},_createToolbarButton:function(t){return e.Node.create('<div class="button" role="button" title="'+(t.desc?t.desc:t.fn)+'" command="'+t.fn+'"><div class="'+t.cls+' icon"></div></div>')},_initToolbar:function(){var t=this.get("editor"),n=this.get("sizeWindow");t.all(".html_toolbar div[role=button]").each(function(e){e.on("mousedown",function(e){e.preventDefault();var t=e.currentTarget.getAttribute("command");if(t)var n=this.get("baseEditor").execCommand(t);return!1},this)},this),n.get("contentBox").all("div[role=menuitem]").each(function(t){t.on("mousedown",e.bind(function(e){e.preventDefault();var t=this.get("baseEditor").getInstance(),n=new t.Selection,r=e.currentTarget;if(n&&!n.isCollapsed){if(i=r.getAttribute("data-style")){var i=i.split(": ");n.anchorNode.setStyle(i[0],i[1])}else(command=r.getAttribute("command"))&&this.get("baseEditor").execCommand("formatblock",r.getAttribute("command"));n.focusCursor(!0,!0)}else(command=r.getAttribute("command"))&&this.get("baseEditor").execCommand("insertandfocus","<"+r.getAttribute("command")+">&nbsp;<br></"+r.getAttribute("command")+">");return this.get("sizeWindow").hide(),!1},this))},this),this.get("baseEditor").before("nodeChange",function(t){switch(t.changedType){case"backspace-up":if(e.UA.webkit)return t.preventDefault
(),t.stopPropagation(),!1}},this),this.get("baseEditor").after("nodeChange",function(e){switch(e.changedType){case"enter":e.changedNode.get("tagName")==="BLOCKQUOTE"&&!e.changedEvent.shiftKey&&(e.preventDefault(),this.get("baseEditor").execCommand("insertandfocus","</blockquote><p><br></p>"));break;case"keyup":case"mousedown":this._updateButtons(e)}e.classNames="",e.fontFamily="",e.fontSize="",e.fontColor="",e.backgroundColor=""},this),this.get("baseEditor").before("nodeChange",function(e){switch(e.changedType){case"paste":this.flagPaste=!0;break;case"keyup":this.flagPaste===!0&&e.changedNode.set("innerHTML",e.changedNode.get("text"));default:this.flagPaste=!1}},this),this.get("baseEditor").after("nodeChange",function(e){if(e.changedType==="mouseup"){e.preventDefault();var t=e.changedNode;t.changedType=e.changedType,t.get("tagName")==="A"?this.get("baseEditor").execCommand("link",t):t.get("tagName")==="IMG"&&this.get("baseEditor").execCommand("media",t)}},this),t.one(".e9").on("click",e.bind(this._toggleComposer,this,!1)),t.one(".k9").on("click",e.bind(this._toggleComposer,this,!0)),t.one(".u9").on("click",e.bind(this._formatHtml,this,!0)),this.get("formEl")&&e.all(this.get("formEl")).size()===1&&e.one(this.get("formEl")).before("submit",e.bind(this.submitForm,this))},_formatHtml:function(){if(typeof i!="undefined"){var e=this.get("textArea").get("value");this.get("baseEditor").set("content",e);var t=i.init(this.get("frameInstance").one("body"));this.get("textArea").set("value",t)}},_updateButtons:function(t){var n=this.get("editor"),r=t.changedNode,i=t.commands;if(r){var s=this.get("baseEditor").getDomPath(r,!1);n.all(".html_toolbar div[role=button]").removeClass("active"),e.each(s,function(e){var t=this.tag2cmd[e.tagName.toLowerCase()];t&&n.all(".html_toolbar div[role=button]").each(function(e){e.getAttribute("command")===t&&e.addClass("active")})},this)}},_toggleComposer:function(e){var t=this.get("editor");try{this.set("visualEditMode",e),e===!0?(this.get("baseEditor").set("content",this._formatDom()+this.textAreaTextDefault),t.one(".html_toolbar").setStyle("display","block"),t.one(".plain_toolbar").setStyle("display","none"),t.one(".f9").setStyle("display","none"),t.one(".f8").setStyle("display","block")):(this.get("textArea").set("value",this._cleanDom()),t.one(".html_toolbar").setStyle("display","none"),t.one(".plain_toolbar").setStyle("display","block"),t.one(".f9").setStyle("display","block"),t.one(".f8").setStyle("display","none"))}catch(n){}},_formatDom:function(){var e=this.get("textArea").get("value");return e.length<1?"":e},_cleanNodes:function(){var t=this.get("frameInstance").one("body").all("*");t.each(function(t){if(t.ancestor(".gridbuilder",!0))return;if(t.get("tagName")==="B"){var n=e.Node.create("<strong></strong>");n.set("innerHTML",t.get("innerHTML")),t.replace(n)}if(t.get("tagName")==="I"){var n=e.Node.create("<em></em>");n.set("innerHTML",t.get("innerHTML")),t.replace(n)}if(t.get("tagName")==="SPAN"){var r=!1;e.each(this.styles,function(e,n){style=t.getStyle(n),e===!0&&style&&style!=="normal"&&style!=="justify"&&style!=="none"&&style!=="start"?r=!0:t.setStyle(n,"")});if(r===!1||t.hasClass("Apple-style-span"))t.get("parentNode").insertBefore(t.get("childNodes"),t),t.remove()}if(t.get("tagName")==="DIV"&&this._getInnerText(t,!0).length>0&&t.get("innerHTML").search(this.regexps.divToPElementsRe)===-1){var n=e.Node.create("<p></p>");n.set("innerHTML",t.get("innerHTML")),t.replace(n)}t.get("tagName").match(/^(ul|ol|blockquote|p|li|em|strong|h3|h2)$/i)&&this._getInnerText(t,!0).length===0&&t.all("img, iframe, object, br").size()===0&&t.remove();if(t.get("tagName")==="P"&&this._getInnerText(t,!0).length===0&&t.one("*")&&(t.one("*").get("tagName")==="IFRAME"||t.one("*").get("tagName")==="IMG")){var n=e.Node.create("<div></div>");n.addClass("media"),n.set("innerHTML",t.get("innerHTML")),t.replace(n)}t.get("tagName")==="VAR"&&(t.get("parentNode").insertBefore(t.get("childNodes"),t),t.remove())},this)},_cleanDom:function(){this._cleanNodes();var e=this.get("baseEditor").getContent();return e=e.replace(this.regexps.replaceBrsRe,"</p><p>"),e=e.replace(/&nbsp;/gi," "),e=e.replace(/<br>([\S+])?<p>/gi,"<p>"),e=e.replace(/<\/p>([\S+])?<br>/gi,"</p>"),e=e.replace(/<(div|p|span)>([\S+])?(<br>)?<\/(div|p|span)>/gi,""),e=e.replace(/ style=""/gi,""),e},_getInnerText:function(e,t){var n="";return t=typeof t=="undefined"?!0:t,n=e.get("text").replace(this.regexps.trimRe,""),t&&!e.hasChildNodes()&&e.set("text",n.replace(this.regexps.normalizeRe," ")),n},submitForm:function(e){this.get("visualEditMode")===!0&&this.get("textArea").set("value",this._cleanDom()),this.get("textArea").set("value",this._formatDom())},getContent:function(){return this.get("visualEditMode")===!0&&this.get("textArea").set("value",this._cleanDom()),this._formatDom()},test:function(){}}),e.EditorUI=n,r.NAME="EditorImageManage",r.ATTRS={frameEl:{value:null,writeOnce:!0},uploadToUrl:{value:"/build/gallery-editor-ui/assets/fake-upload.html",validator:e.Lang.isString,writeOnce:!0},resizeHeight:{value:!0,validator:e.Lang.isBoolean,writeOnce:!0},drawUI:{value:!0},file:null,cellImageSizes:{value:{width:0,height:0},setter:function(e){return e.height=parseInt(e.height,10),e.width=parseInt(e.width,10),e}},canvasImageSizes:{value:{width:0,height:0},setter:function(e){return e.height=parseInt(e.height,10),e.width=parseInt(e.width,10),e}},cell:null,top:{value:0},left:{value:0},img:null,img_src:null,zoom:{value:1},resize:{value:1}},e.extend(r,e.Base,{renderUI:function(){},destructor:function(){},initializer:function(){var t=this.get("cellImageSizes"),n=this.get("canvasImageSizes"),r=this.get("frameEl"),i;if(!r||!r._node){if(!r||!e.one(r))return;r=e.one(this.get("frameEl")),this.set("frameEl",r)}this.publish("upload:start"),this.publish("upload:error"),this.publish("upload:complete"),i=e.Node.create('<div class="visual"></div>'),this.set("cell",i),r.empty().appendChild(i),n.width===0&&n.height===0&&(n={width:t.width,height:t.height}
),this.set("canvasImageSizes",n),i.setStyle("width",t.width+"px").setStyle("height",t.height+"px"),this.uploadCanvas=e.Node.create('<canvas class="canvas"></canvas>'),this.uploadTo=this.uploadCanvas.invoke("getContext","2d"),this.uploadCanvasCopy=e.Node.create('<canvas class="canvas"></canvas>'),this.uploadToCopy=this.uploadCanvasCopy.invoke("getContext","2d"),this.uploadButton=e.Node.create('<input type="file" class="upload" accept="image/*">'),i.appendChild(this.uploadButton),i.appendChild(this.uploadCanvas);if(this.get("drawUI")){this.zoomBtns=e.Node.create('<div class="zoom button in" title="Zoom In">+</div> <div class=" zoom button out" title="Zoom Out">-</div>'),this.zoomBtns.one(".in").on("click",e.bind(function(e){var t=parseFloat(this.get("zoom")*1.05);this.set("zoom",t),this.drawCanvas()},this)),this.zoomBtns.one(".out").on("click",e.bind(function(e){var t=parseFloat(this.get("zoom")*.95);t>1?this.set("zoom",t):this.set("zoom",1),this.drawCanvas()},this)),i.appendChild(this.zoomBtns),this.saveBtn=e.Node.create('<a class="save button" title="Save image">Save</a>'),this.saveBtn.on("click",e.bind(function(e){this.saveImage()},this)),i.appendChild(this.saveBtn),this.clearBtn=e.Node.create('<a class="delete button" title="Remove image">x</a>'),this.clearBtn.on("click",e.bind(function(e){this.get("cell").removeClass("active"),this.clearCanvas()},this)),i.appendChild(this.clearBtn);if(this.get("resizeHeight")===!0){var s=e.Node.create('<input class="heightRow" value="'+t.height+'px">');s.on(["blur","submit"],e.bind(function(e){var t=e.currentTarget.get("parentNode"),n=parseInt(e.currentTarget.get("value"),10);n>10&&this.setHeight(n+6)},this)),i.appendChild(s)}}if(this.get("resizeHeight")===!0){var o=new e.Resize({node:r,handles:"b",minHeight:55,maxHeight:600,preserveRatio:!1});o.on("resize:resize",e.bind(function(e){var t=e.currentTarget.get("node"),n=parseInt(e.currentTarget.info.offsetHeight,10);this.setHeight(n),t.all(".heightRow").set("value",n-6+"px")},this))}this.get("file")&&(this.set("img",e.Node.create("<img>")),this.get("img").on("load",e.bind(this.prepareImg,this)),this.get("img").on("error",e.bind(this.errorImg,this)),this.get("file").indexOf(document.location.hostname)>0||this.get("file").substr(0,1)==="/"?this.get("img").set("src",this.get("file")):this.get("img").set("src",this.get("uploadToUrl")+"?proxy="+encodeURIComponent(this.get("file"))),this.uploadCanvas.setStyle("position","relative"),this.uploadCanvas.setStyle("top",this.get("top")+"px"),this.uploadCanvas.setStyle("left",this.get("left")+"px")),this.uploadButton.on("change",e.bind(this.loadLocalImage,this)),e.on("windowresize",e.bind(this.contrainMove,this))},support:function(){return window.File&&window.FileReader&&window.FileList&&window.Blob?!0:!1},loadLocalImage:function(t){this.clearCanvas(),this.set("img",e.Node.create("<img>")),this.get("img").detach("load"),this.get("img").on("load",e.bind(this.prepareImg,this));var n=t.target.get("files");if(n&&n.size()>0){var r=n._nodes[0];if(typeof FileReader!="undefined"&&r.type.indexOf("image")!==-1){var i=new FileReader;i.onload=e.bind(function(e){this.get("img").set("src",e.target.result)},this),i.readAsDataURL(r)}}t.stopPropagation(),t.preventDefault()},prepareImg:function(e){this.set("img_src",e.target._node),this.uploadCanvasCopy.set("width",e.target._node.width),this.uploadCanvasCopy.set("height",e.target._node.height),this.uploadToCopy.drawImage(e.target._node,0,0,e.target._node.width,e.target._node.height),this.drawCanvas()},errorImg:function(e){},drawCanvas:function(){var e=this.get("img"),t=this.get("img_src"),n=this.get("canvasImageSizes"),r=this.get("cell");r.addClass("active");var i=this.resizeDimensions(t,n);t.width=i.width,t.height=i.height,t.height=t.height*this.get("zoom"),t.width=t.width*this.get("zoom"),this.uploadCanvas.set("width",t.width),this.uploadCanvas.set("height",t.height),this.set("resize",this.uploadCanvasCopy.get("height")/this.uploadCanvas.get("height")),this.uploadTo.drawImage(t,0,0,t.width,t.height),this.contrainMove()},resizeDimensions:function(e,t){var n=e.height/e.width,r={height:e.height,width:e.width,resize:100};if(e.width>=t.width||e.height>=t.height)t.width<=t.height&&e.height<=e.width&&e.height>=t.height||e.width>=t.width&&(r.width=t.width,r.height=Math.round(t.width*n));return r},contrainMove:function(){var t=this.get("img"),n=this.get("cell"),r=parseInt(this.uploadCanvas.getStyle("top"),10),i=parseInt(this.uploadCanvas.getStyle("left"),10);if(this.uploadCanvas.get("width")<parseInt(n.getStyle("width"),10))var s=parseInt(n.getStyle("width"),10)-this.uploadCanvas.get("width");else var s=0;if(this.uploadCanvas.get("height")<parseInt(n.getStyle("height"),10))var o=parseInt(n.getStyle("height"),10)-this.uploadCanvas.get("height");else var o=0;var u=this.uploadCanvas.getXY();this.drag&&this.drag.destroy(),this.drag=(new e.DD.Drag({node:this.uploadCanvas})).plug(e.Plugin.DDConstrained,{constrain:{top:u[1]-r-(this.uploadCanvas.get("height")-(this.uploadCanvas.get("height")>parseInt(n.getStyle("height"),10)?parseInt(n.getStyle("height"),10):this.uploadCanvas.get("height"))),left:u[0]-i-(this.uploadCanvas.get("width")-(this.uploadCanvas.get("width")>parseInt(n.getStyle("width"),10)?parseInt(n.getStyle("width"),10):this.uploadCanvas.get("width"))),right:u[0]+this.uploadCanvas.get("width")+s-i,bottom:u[1]+this.uploadCanvas.get("height")+o-r}}),this.drag.on("drag:end",e.bind(function(e){this.set("top",parseInt(this.uploadCanvas.getStyle("top"),10)),this.set("left",parseInt(this.uploadCanvas.getStyle("left"),10)),this.contrainMove()},this))},clearCanvas:function(){this.uploadCanvas.setStyle("top","0px"),this.uploadCanvas.setStyle("left","0px"),this.set("zoom",1),this.uploadTo.clearRect(0,0,this.uploadCanvas.get("width"),this.uploadCanvas.get("height"))},convertToBlob:function(e){var t=atob(e.split(",")[1]),n=[];for(var r=0;r<t.length;r++)n.push(t.charCodeAt(r));return new Blob([new Uint8Array(n)],{type:"image/jpeg"})},getFile:function()
{if(this.get("cell").hasClass("active")){var t=this.convertToBlob(this.getImage());return e.FileHTML5.prototype._isValidFile=function(){return!0},new e.FileHTML5({file:t})}return!1},getFileDetails:function(){var e=this.get("cellImageSizes");return{top:this.get("top"),left:this.get("left"),zoom:this.get("zoom"),width:e.width,height:e.height,resize:this.get("resize")}},getImage:function(){return this.uploadCanvasCopy._node.toDataURL("image/jpeg","0.8")},setHeight:function(e){var t=this.get("cellImageSizes");t.height=e-6,this.set("cellImageSizes",t),this.get("cell").setStyle("height",t.height+"px").setStyle("width",t.width+"px"),this.contrainMove()},saveImage:function(){var t=this.getFile();if(t){var n=new e.UploaderHTML5;n.on("uploadstart",e.bind(function(e){this.fire("upload:start",e)},this)),n.on("uploaderror",e.bind(function(e){this.fire("upload:error",e)},this)),n.on("uploadcomplete",e.bind(function(e){this.fire("upload:complete",e)},this)),n.upload(t,this.get("uploadToUrl"),this.getFileDetails())}}}),e.EditorImageManage=r;var i={html:[],indent:"  ",trimRe:/^\s+|\s+$/gi,inlineNodeRe:/^(img|br|sup|sub)$/i,newLineNodeRe:/^(div|p|img|blockquote|q|iframe|pre|code|table|tbody|th|td|tr|ul|ol|li|h1|h2|h3|h4|h5|h6|dl|dt|dd|form|fieldset|legend|iframe)$/i,notCloseNodesRe:/^(img|br)$/i,firstNodeRe:/^(<[^>]+>)/i,replaceNodesRe:/^(script|style|meta|body|head|title|link)/i,keepAttributesRe:/^(src|style|width|height|class|title|alt|data-)/i,init:function(e){return this.html=[],e===null?"":(e&&e._node?this._dive(e.getDOMNode(),0):this._dive(e,0),this.html.join(""))},_dive:function(e,t){var n=e.firstChild;if(!e)return;while(n!==null){var r=n.hasChildNodes()>0&&n.firstChild.nodeType===3&&n.firstChild.nodeValue.replace(this.trimRe,"").length>0;if(n.nodeType===1){var i=n.nodeName.toLowerCase(),s=n.attributes,o="<"+i;for(var u=0;u<s.length;u++)o+=" "+s[u].name+'="'+s[u].value+'"';o+=">";var a="",f="";i.search(this.newLineNodeRe)===-1?f="":r||!i.search(this.inlineNodeRe)===-1?f=""+this._indenter(t):(a="\n",f=""+this._indenter(t)),this.html.push(f+o),r||this.html.push(a),this._dive(n,t+1)}else n.nodeType===3?n.nodeValue.replace(this.trimRe,"").length>0&&this.html.push(n.nodeValue):n.nodeType===8&&this.html.push("<!-- "+n.nodeValue.replace(this.trimRe,"")+" -->\n");if(n.nodeType===1){var i=n.nodeName.toLowerCase();if(i.search(this.notCloseNodesRe)===-1)if(i.search(this.newLineNodeRe)===-1)this.html.push("</"+i+">");else if(r)this.html.push("</"+i+">\n");else{var f=this._indenter(t);this.html.push(f+"</"+i+">\n")}}n=n.nextSibling}},_indenter:function(e){var t="";for(var n=0;n<e;n++)t+=this.indent;return t}}},"@VERSION@",{skinnable:!0,requires:["base","editor","event","node","panel","overlay","dd-drag","dd-constrain","uploader","resize","json"]});
