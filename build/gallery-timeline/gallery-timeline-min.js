YUI.add("gallery-timeline",function(a){var b=a.Lang,o="region",t="start",d="end",l="left",g="url",p="container",c="loaded",k="Change",f="event",s="categories",n="top",w="center",j="right",i="px",u="strings",v="timeline",q="showDescr",e=function(){return a.ClassNameManager.getClassName.apply(this,[v].concat(a.Array(arguments)));},x=a.Node.create('<div class="'+e("bar")+'" />'),r=a.Node.create('<div class="'+e("grid")+'"/>'),h=a.Node.create('<div class="'+e("pointer")+'" />'),m='<div class="'+e("cats")+'">{categories}<p class="'+e("noCat")+'">{noCategory}</p></div>';a.Timeline=a.Base.create(v,a.Base,[],{_events:null,_mode:0,initializer:function(y){this._events=[];this.set(u,a.Intl.get("gallery-"+v));this.after(g+k,this._load);this.after(p+k,this._render);this.after(c+k,this._render);if(y&&y[g]){this._load();}if(y&&y[p]){this._render();}this.publish(q,{defaultFn:this._defShowDescr});},_readBoolean:function(z,y){var A=this._readValue(z,y);return A?A.toLowerCase()==="true":null;},_readDate:function(A,y){var z,B,C=this._readValue(A,y);if(C){C=C.split(" ");z=C[0].split("-");B=C[1].split(":");return new Date(z[0],z[1]-1,z[2],B[0],B[1],B[2]).getTime();}else{return null;}},_readColor:function(z,y){var B=this._readValue(z,y),A=function(C){return("00"+parseInt(C,10).toString(16)).substr(-2);};if(B){B=B.split(",");return"#"+A(B[0])+A(B[1])+A(B[2]);}else{return null;}},_readValue:function(z,y){var A=this._readEl(z,y);return A?A.textContent:null;},_readEl:function(z,y){var A=z.getElementsByTagName(y);return(A&&A.length)?A[0]:null;},_xmlReadCategories:function(y){var z={};a.each(y.children,function(A){z[this._readValue(A,"name")]={color:this._readColor(A,"color"),fontColor:this._readColor(A,"font_color")};},this);this.set(s,z);},_xmlReadView:function(y){var z=this._readEl(y,"displayed_period"),A=this.get(s),B=this._readEl(y,"hidden_categories").firstChild;if(z){this.set(t,this._readDate(z,t));this.set(d,this._readDate(z,d));}while(B){A[B.textContent].hidden=true;B=B.nextChild;}},_xmlReadEvents:function(y){this._events=[];a.each(y.children,function(z){this._events.push({start:this._readDate(z,t),end:this._readDate(z,d),text:this._readValue(z,"text"),fuzzy:this._readBoolean(z,"fuzzy"),locked:this._readBoolean(z,"locked"),endsToday:this._readBoolean(z,"ends_today"),category:this._readValue(z,"category"),description:this._readValue(z,"description"),icon:this._readValue(z,"icon")});},this);},load:function(y){this.set(g,y);return this;},_load:function(){var y=this;y.set(c,false);a.io(y.get(g),{on:{success:function(B,A){var z=A.responseXML;y._xmlReadCategories(y._readEl(z,s));y._xmlReadView(y._readEl(z,"view"));y._xmlReadEvents(y._readEl(z,"events"));y.set(c,true);}}});},_getRegion:function(z){var y=z.get(o);y.left-=this._left;y.top-=this._top;return y;},_resize:function(z){z=z||this.get(p);var B=this.get(t),E=this.get(d),K=this._width,M=this._height,D=K/(E-B),L=this.get(s),I,A,C,G=false,J,y,H=false,F=this.get(u).today,N=function(O){return a.DataType.Date.format(new Date(O),{format:"%x"});};a.each(this._events,function(O){if(O.category&&L[O.category].hidden){return;}I=O._bar||x.cloneNode();y=O._pointer;C=Math.round((O.start-B)*D);A=Math.round(((O.endsToday?Date.now():O.end)-O.start)*D);if(C+A<0||C>K){if(O._bar){O._bar.remove(true);O._bar=null;if(y){y.remove(true);O._pointer=y=null;}}G=true;return;}O._isPoint=A===0;I.setStyles({left:C+i,width:A?A+i:"auto"});if(!O._bar){O._bar=I;if(O.category){I.setStyles({backgroundColor:L[O.category].color,color:L[O.category].fontColor});}else{H=true;}I.setContent(O.text);I.set("title",O.text+": "+N(O.start)+" - "+(O.endsToday?F:N(O.end)));if(O.fuzzy){I.addClass(e("fuzzy"));}if(O.description||O.icon){I.addClass(e("hasDescr"));}I.setData(f,O);}if(!I.inDoc()){z.append(I);G=true;}if(O._isPoint){J=this._getRegion(I);I.setStyle(l,J.left-J.width/2+i);if(!y){O._pointer=y=h.cloneNode();y.setStyle(n,M/2+i);}}else{if(y){y.remove(true);O._pointer=y=null;G=true;}}if(y){y.setStyle(l,C+i);if(!y.inDoc()){z.append(y);}}},this);if(G){this._locate();}z.one("."+e("noCat")).setStyle("display",H?"block":"none");},_locate:function(){var z,B,F,J=this._height/2,H=[],y=[],I,G,E=this._mode,D=0,C=0,A=function(M,N,L,K){var O;switch(E){case 0:O=K?30*L+15:-30*(L+1)-15;break;case 1:O=K?15*L+10:-15*(L+1)-10;break;case 2:O=K?5*L+10:-5*(L+1)-10;break;}D=Math.min(D,O);C=Math.max(C,O);M.setStyle(n,J+O+i);if(!N[L]){N[L]=[];}N[L].push({left:B,width:z});var P=M.getData(f)._pointer;if(P){P.setStyle("height",30*L+15);}};this.get(p).all("div."+e("bar")).each(function(K){F=this._getRegion(K);z=F.width;B=F.left;G=K.getData(f)._isPoint;I=(G?H:y);if(!a.some(I,function(M,L){if(!a.some(M,function(N){return !(N.left>(B+z)||B>(N.left+N.width));})){A(K,I,L,G);return true;}return false;},this)){A(K,I,I.length,G);}},this);D=Math.max(-D,C);if(D>J){if(E<2){this._mode+=1;this._locate();this.get(p).addClass(e("compact"));}}else{if(D<J/3){if(E){this._mode-=1;if(this._mode===0){this.get(p).removeClass(e("compact"));}this._locate();}}}},_grid:function(){var A=this.get(t),E=this.get(d),y=this.get(p),B=this._width,L=this._height,H=E-A,J=[1000*60*60,24,30,12,10,10,10,10],I=1,F,G,z,C,K,D,M=function(P,N,O){P=new Date(P);switch(N){case 0:return new Date(P.getFullYear(),P.getMonth(),P.getDate(),P.getHours()+O,0,0).getTime();case 1:return new Date(P.getFullYear(),P.getMonth(),P.getDate()+O).getTime();case 2:return new Date(P.getFullYear(),P.getMonth()+O,1).getTime();default:N=Math.pow(10,N-3);return new Date(Math.floor(P.getFullYear()/N)*N+(O?N:0),0,1).getTime();}};y.all("div."+e("grid")).remove(true);for(F=0;F<J.length;F+=1){I*=J[F];if(B/H*I>20){break;}}C=M(A,F,0);while(C<E){G=M(C,F,1);D=new Date(C);z=r.cloneNode();K=[D.getHours()];if(K[0]===0){K[1]=D.getDate();if(K[1]===1){K[2]=D.getMonth();if(K[2]===0){K[3]=D.getFullYear();}K[2]=a.DataType.Date.format(D,{format:"%b"});}}z.setContent(K.slice(Math.min(3,F)).join(", "));z.setStyles({width:Math.round((G-C)/H*B)-1+i,left:Math.round((C-A)/H*B)+i,paddingTop:L/2+i,height:L/2+i});y.append(z);C=G;}},render:function(y){this.set(p,y);
return this;},_render:function(){var y=this.get(p);if(!(y&&this.get(c))){return;}y.addClass(e());y.setContent("");a.each(this._events,function(B){delete B._pointer;delete B._bar;delete B._isPoint;});var A=y.get(o);this._left=A.left;this._top=A.top;this._height=A.height;this._width=A.width;y.append(a.Node.create('<div class="'+e("divider")+'"/>'));var z=y.appendChild(a.Node.create(b.sub(m,this.get(u))));a.each(this.get(s),function(B,C){if(!B.hidden){z.append(a.Node.create('<p style="color:'+B.fontColor+";background-color:"+B.color+'">'+C+"</p>"));}});this._descr=y.appendChild(a.Node.create('<div class="'+e("descr")+'"/>'));this._grid();this._resize(y);y.delegate("click",this._showDescr,"div."+e("bar"),this);y.delegate("hover",function(B){B.target.setStyle("zIndex",9);},function(B){B.target.setStyle("zIndex",0);},"div."+e("bar"));y.on("gesturemovestart",this._startMove,{},this);y.on("gesturemove",this._dragMove,{},this);y.on("gesturemoveend",this._dragMove,{},this);a.on("mousewheel",this._mouseWheel,this);return;},_hideDescr:function(){this._descr.setStyle("display","none");},_showDescr:function(A){var z=A.target,y=z.getData(f);this.fire(q,{bar:z,event:y,callback:this.showDescr});},_defShowDescr:function(A){var z=A.bar,y=A.event;this.showDescr(z,y);},showDescr:function(C,B){var A=this._getRegion(C),E=this._descr,y,D=A.left+A.width/2,z=this._width/3;if(B.description||B.icon){E.setContent((B.icon?'<img src="data:image/png;base64,'+B.icon+'">':"")+B.description);E.setStyles({display:"block",top:0});E.removeClass(e(l));E.removeClass(e(w));E.removeClass(e(j));y=this._getRegion(E);if(D<z){E.setStyle(l,Math.max(D,0)+i);E.addClass(e(l));}else{if(D<z*2){E.setStyle(l,D-y.width/2+i);E.addClass(e(w));}else{E.setStyle(l,Math.min(D,this._width-30)-y.width+i);E.addClass(e(j));}}E.setStyle(n,Math.round(A.top-y.height-20)+i);}},_startMove:function(y){y.halt();this._hideDescr();this._pageX=y.pageX;this._start=this.get(t);this._end=this.get(d);},_dragMove:function(B){var C=this._start,z=this._end,A=this._width,y=Math.round((B.pageX-this._pageX)/A*(z-C));if(y){this.set(t,C-y);if(B.ctrlKey){this.set(d,z+y);this._locate();}else{this.set(d,z-y);}this._resize();this._grid();}},_mouseWheel:function(A){if(A.target.ancestor("#"+this.get(p).get("id"),true)){A.halt();this._hideDescr();var B=this.get(t),z=this.get(d),y=(z-B)*0.1*(A.wheelDelta>0?-1:1);this.set(t,B-y);if(A.ctrlKey){this.set(d,z+y);this._locate();}else{this.set(d,z-y);}this._resize();this._grid();}}},{ATTRS:{categories:{validator:b.isObject,value:{}},start:{validator:b.isNumber,value:new Date(Date.now()-1000*60*60*24*30).getTime()},end:{validator:b.isNumber,value:new Date(Date.now()+1000*60*60*24*30).getTime()},container:{setter:function(y){return a.one(y);}},url:{validator:b.isString},loaded:{validator:b.isBoolean,value:false},strings:{value:{categories:"Categories",noCategory:"-no category-",today:"today"}}}});},"gallery-2012.03.23-18-00",{lang:["en","es"],optional:["intl"],requires:["node","io-base","base","event-mousewheel","event-gestures","classnamemanager","datatype","event-hover"],skinnable:true});