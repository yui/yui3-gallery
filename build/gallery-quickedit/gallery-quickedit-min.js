YUI.add("gallery-quickedit",function(b){function d(o){d.superclass.constructor.call(this,o);}d.NAME="QuickEditPlugin";d.NS="qe";d.ATTRS={changesAlwaysInclude:{value:[],validator:b.Lang.isArray}};var k=/quickedit-key:([^\s]+)/,i="quickedit-has",e=i+"([a-z]+)",h=new RegExp(b.Node.class_re_prefix+e+b.Node.class_re_suffix),m="quickedit-has",l=m+"([a-z]+)",j=new RegExp(b.Node.class_re_prefix+l+b.Node.class_re_suffix);d.error_text_class="quickedit-message-text";d.error_display_markup='<div class="quickedit-message-text"></div>';d.copy_down_button_class="quickedit-copy-down";d.textFormatter=function(r){var p='<input type="text" class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+"{cd}"+d.error_display_markup;var q=r.column.quickEdit;return b.Lang.sub(p,{key:r.column.key,value:r.value.toString().replace(/"/g,"&quot;"),yiv:q.validation?(q.validation.css||""):"",cd:d.copyDownFormatter.call(this,r)});};d.textareaFormatter=function(r){var p='<textarea class="{yiv} quickedit-field quickedit-key:{key}">{value}</textarea>'+"{cd}"+d.error_display_markup;var q=r.column.quickEdit;return b.Lang.sub(p,{key:r.column.key,value:r.value,yiv:q.validation?(q.validation.css||""):"",cd:d.copyDownFormatter.call(this,r)});};d.readonlyEmailFormatter=function(p){return(p.value||"");};d.readonlyLinkFormatter=function(p){return(p.value||"");};function f(r){var o=r.currentTarget.ancestor(".yui3-datatable-cell");var q=o.one(".quickedit-field");if(!q){return;}var p=b.Lang.trim(q.get("value"));if(!p&&p!==0){return;}while(1){o=this.getCell(o,"below");if(!o){break;}q=o.one(".quickedit-field");if(q){q.set("value",p);}}}d.copyDownFormatter=function(p,q){if(p.column.quickEdit.copyDown&&p.rowIndex===0){return b.Lang.sub('<button title="Copy down" class="{c}">&darr;</button>',{c:d.copy_down_button_class});}else{return"";}};function c(p,o){return function(q){if(!q.record&&b.Lang.isString(o)){return o;}else{return(q.record?p:o).apply(this,arguments);}};}function n(q){var o=this.getCell(q.target,q.charCode==38?"above":"below");if(o){var p=o.one(".quickedit-field");if(p){p.focus();p.select();q.halt(true);}}}function a(){var q=this.get("host").get("columns");var p={};function o(t,s){if(b.Lang.isString(s)){var r={key:s};t.push(r);p[s]=r;}else{if(s.children){t=b.reduce(s.children,t,o);}else{t.push(s);p[s.key]=s;}}return t;}this.column_list=b.reduce(q,[],o);this.column_map=p;}function g(u){var w=this.get("host");var q=true;var s=u.size();for(var r=0;r<s;r++){var t=u.item(r);var p=this.column_map[this._getColumnKey(t)].quickEdit;if(!p){continue;}var v=p.validation?p.validation.msg:null;var o=b.FormManager.validateFromCSSData(t,v);if(o.error){this.displayMessage(t,o.error,"error");q=false;continue;}if(o.keepGoing){if(p.validation&&p.validation.regex instanceof RegExp&&!p.validation.regex.test(t.get("value"))){this.displayMessage(t,v?v.regex:null,"error");q=false;continue;}}if(p.validation&&b.Lang.isFunction(p.validation.fn)&&!p.validation.fn.call(w,t)){q=false;continue;}}return q;}b.extend(d,b.Plugin.Base,{initializer:function(o){var q=this.get("host");this.hasMessages=false;a.call(this);this.get("host").after("columnsChange",a,this);var p=this.afterHostEvent("render",function(){q.get("boundingBox").delegate("click",f,"."+d.copy_down_button_class,q);p.detach();});},start:function(){this.fire("clearErrorNotification");var u=this.get("host");this.saveSort=[];this.saveEdit=[];this.saveFmt={};for(var s=0;s<this.column_list.length;s++){var q=this.column_list[s];var r=q.key;this.saveSort.push(q.sortable);q.sortable=false;var p=q.quickEdit;var v=q.qeFormatter;if(
/*!col.hidden &&*/
(p||v)){var t=null;if(p&&b.Lang.isFunction(p.formatter)){t=p.formatter;}else{if(b.Lang.isFunction(v)){t=v;}else{t=d.textFormatter;}}if(t){this.saveFmt[r]={formatter:q.formatter,nodeFormatter:q.nodeFormatter,allowHTML:q.allowHTML};q.formatter=c.call(this,t,q.formatter||q.nodeFormatter);q.nodeFormatter=null;q.allowHTML=true;}}}var o=u.get("contentBox");o.addClass(u.getClassName("quickedit"));this.move_event_handle=o.on("key",n,"down:38+ctrl,40+ctrl",u);u.set("columns",u.get("columns"));},cancel:function(){this.fire("clearErrorNotification");for(var q=0;q<this.column_list.length;q++){var p=this.column_list[q];p.sortable=this.saveSort[q];}delete this.saveSort;delete this.saveEdit;b.each(this.saveFmt,function(s,u){var t=this.column_map[u];t.formatter=s.formatter;t.nodeFormatter=s.nodeFormatter;t.allowHTML=s.allowHTML;},this);delete this.saveFmt;var r=this.get("host");var o=r.get("contentBox");o.removeClass(r.getClassName("quickedit"));if(this.move_event_handle){this.move_event_handle.detach();delete this.move_event_handle;}r.set("columns",r.get("columns"));},getChanges:function(){if(!this.validate()){return false;}var p=[];var o=this.get("changesAlwaysInclude");var q=this.get("host");var r=q._tbodyNode.get("children");q.get("data").each(function(v,x){var y=r.item(x).all(".quickedit-field");var z={};p.push(z);var A=y.size();for(var w=0;w<A;w++){var B=y.item(w);var C=this._getColumnKey(B);var u=this.column_map[C].quickEdit;var t=v.get(C);var s=b.Lang.trim(B.get("value"));if(u.changed?u.changed(t,s):s!==(t?t.toString():"")){z[C]=s;}}for(var w=0;w<o.length;w++){var C=o[w];z[C]=v.get(C);}},this);return p;},validate:function(){this.clearMessages();var o=true;var p=this.get("host");var s=p._tbodyNode.getElementsByTagName("input");var r=p._tbodyNode.getElementsByTagName("textarea");var q=p._tbodyNode.getElementsByTagName("select");o=g.call(this,s)&&o;o=g.call(this,r)&&o;o=g.call(this,q)&&o;if(!o){this.fire("notifyErrors");}return o;},clearMessages:function(){this.hasMessages=false;this.fire("clearErrorNotification");var o=this.get("host");o._tbodyNode.getElementsByClassName(e).removeClass(e);o._tbodyNode.getElementsByClassName(l).removeClass(l);o._tbodyNode.all("."+d.error_text_class).set("innerHTML","");},displayMessage:function(r,t,q,p){if(b.Lang.isUndefined(p)){p=true;}r=b.one(r);var s=r.getAncestorByTagName("tr");if(b.FormManager.statusTakesPrecedence(this._getElementStatus(s,h),q)){if(!this.hasMessages&&p){b.one(s.get("firstChild")).scrollIntoView();
}s.replaceClass(e,i+q);this.hasMessages=true;}var o=r.getAncestorByTagName("td");if(b.FormManager.statusTakesPrecedence(this._getElementStatus(o,j),q)){if(t){o.one("."+d.error_text_class).set("innerHTML",t);}o.replaceClass(l,m+q);this.hasMessages=true;}},_getElementStatus:function(q,p){var o=q.get("className").match(p);return((o&&o.length)?o[1]:false);},_getColumnKey:function(p){var o=k.exec(p.get("className"));return o[1];}});b.namespace("Plugin");b.Plugin.DataTableQuickEdit=d;},"gallery-2012.04.04-17-55",{skinnable:true,optional:["gallery-scrollintoview"],requires:["datatable-base","gallery-formmgr-css-validation","gallery-node-optimizations","gallery-funcprog"]});