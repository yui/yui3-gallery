YUI.add("gallery-quickedit",function(a){a.Column.ATTRS.quickEdit={};a.Column.ATTRS.qeFormatter={validator:a.Lang.isFunction};function d(q){d.superclass.constructor.call(this,q);}d.NAME="QuickEditPlugin";d.NS="qe";d.ATTRS={changesAlwaysInclude:{value:[],validator:a.Lang.isArray}};var b="(?:^|\\s)(?:",i=")(?:\\s|$)",l=/quickedit-key:([^\s]+)/,j="quickedit-has",e=j+"([a-z]+)",h=new RegExp(b+e+i),n="quickedit-has",m=n+"([a-z]+)",k=new RegExp(b+m+i);d.error_text_class="quickedit-message-text";d.error_display_markup='<div class="quickedit-message-text"></div>';d.textFormatter=function(s){var q='<input type="text" class="{yiv} quickedit-field quickedit-key:{key}"/>'+d.error_display_markup;var r=s.column.get("quickEdit");var t=s.createCell();t.set("innerHTML",a.Lang.sub(q,{key:s.column.get("key"),yiv:r.validation?(r.validation.css||""):""}));t.get("firstChild").set("value",s.value);d.copyDownFormatter.call(this,s,t);};d.textareaFormatter=function(s){var q='<textarea class="{yiv} quickedit-field quickedit-key:{key}"/>'+d.error_display_markup;var r=s.column.get("quickEdit");var t=s.createCell();t.set("innerHTML",a.Lang.sub(q,{key:s.column.get("key"),yiv:r.validation?(r.validation.css||""):""}));t.get("firstChild").set("value",s.value);d.copyDownFormatter.call(this,s,t);};d.readonlyEmailFormatter=function(q){return(q.value||"");};d.readonlyLinkFormatter=function(q){return(q.value||"");};function o(s,r){var u=null;this._tbodyNode.get("children").some(function(v){if(v.contains(s)){u=v;return true;}});if(!u){return null;}var q=s.getAncestorByTagName("td",true);var t=-1;u.get("children").some(function(w,v){if(w===q){t=v;return true;}});u=(r<0?u.previous():u.next());return u?u.get("children").item(t):null;}function f(t,q){var s=q.one(".quickedit-field");if(!s){return;}var r=a.Lang.trim(s.get("value"));if(!r&&r!==0){return;}while(1){q=o.call(this,q,+1);if(!q){break;}s=q.one(".quickedit-field");if(s){s.set("value",r);}}}d.copyDownFormatter=function(r,s){if(r.column.get("quickEdit").copyDown&&r.rowindex===0){var q=a.Node.create("<button></button>");q.set("title","Copy down");q.set("innerHTML","&darr;");s.insert(q,s.one("."+d.error_text_class));q.on("click",f,this,s);}};function c(r,q){return function(s){return(s.record?r:q).apply(this,arguments);};}function p(s){var q=o.call(this,s.target,s.charCode==38?-1:+1);if(q){var r=q.one(".quickedit-field");if(r){r.focus();r.select();s.halt(true);}}}function g(w){var z=this.get("host");var x=z.get("columnset").keyHash;var s=true;var u=w.size();for(var t=0;t<u;t++){var v=w.item(t);var r=x[this._getColumnKey(v)].get("quickEdit");if(!r){continue;}var y=r.validation?r.validation.msg:null;var q=a.FormManager.validateFromCSSData(v,y);if(q.error){this.displayMessage(v,q.error,"error");s=false;continue;}if(q.keepGoing){if(r.validation&&r.validation.regex instanceof RegExp&&!r.validation.regex.test(v.get("value"))){this.displayMessage(v,y?y.regex:null,"error");s=false;continue;}}if(r.validation&&a.Lang.isFunction(r.validation.fn)&&!r.validation.fn.call(z,v)){s=false;continue;}}return s;}a.extend(d,a.Plugin.Base,{initializer:function(q){this.hasMessages=false;},start:function(){this.fire("clearErrorNotification");var z=this.get("host");var w=z.get("columnset").keys;this.saveSort=[];this.saveEdit={};this.saveFmt={};for(var u=0;u<w.length;u++){var s=w[u];var y=s.get("key");this.saveSort.push(s.get("sortable"));s.set("sortable",false);var t=s.get("quickEdit");var A=s.get("qeFormatter");if(
/*!col.hidden &&*/
(t||A)){var x=null;if(t&&a.Lang.isFunction(t.formatter)){x=t.formatter;}else{if(a.Lang.isFunction(A)){x=A;}else{x=d.textFormatter;}}if(x){var v=s.get("formatter");var r=c.call(this,x,v);this.saveFmt[y]=v;s.set("formatter",r);}}}var q=z.get("contentBox");q.addClass(z.getClassName("quickedit"));this.move_event_handle=q.on("key",p,"down:38+ctrl,40+ctrl",z);z.syncUI();},cancel:function(){this.fire("clearErrorNotification");var t=this.get("host");var u=t.get("columnset").keys;for(var s=0;s<u.length;s++){var r=u[s];r.set("sortable",this.saveSort[s]);}delete this.saveSort;delete this.saveEdit;u=t.get("columnset").keyHash;a.Object.each(this.saveFmt,function(v,w){u[w].set("formatter",v);});delete this.saveFmt;var q=t.get("contentBox");q.removeClass(t.getClassName("quickedit"));if(this.move_event_handle){this.move_event_handle.detach();delete this.move_event_handle;}t.syncUI();},getChanges:function(){if(!this.validate()){return false;}var G=[];var u=this.get("changesAlwaysInclude");var A=this.get("host");var E=A.get("recordset");var v=A._tbodyNode.get("children");var y=v.size();var w=A.get("columnset").keyHash;for(var D=0;D<y;D++){var t=E.getRecord(D);var F=v.item(D).all(".quickedit-field");var x={};G.push(x);var z=F.size();for(var C=0;C<z;C++){var q=F.item(C);var I=this._getColumnKey(q);var r=w[I];var s=r.get("quickEdit");var B=t.getValue(I);var H=a.Lang.trim(q.get("value"));if(s.changed?s.changed(B,H):H!==(B?B.toString():"")){x[I]=H;}}for(var C=0;C<u.length;C++){var I=u[C];x[I]=t.getValue(I);}}return G;},validate:function(){this.clearMessages();var q=true;var r=this.get("host");var u=r._tbodyNode.getElementsByTagName("input");var t=r._tbodyNode.getElementsByTagName("textarea");var s=r._tbodyNode.getElementsByTagName("select");q=g.call(this,u)&&q;q=g.call(this,t)&&q;q=g.call(this,s)&&q;if(!q){this.fire("notifyErrors");}return q;},clearMessages:function(){this.hasMessages=false;this.fire("clearErrorNotification");var q=this.get("host");q._tbodyNode.getElementsByClassName(e).removeClass(e);q._tbodyNode.getElementsByClassName(m).removeClass(m);q._tbodyNode.all("."+d.error_text_class).set("innerHTML","");},displayMessage:function(t,v,s,r){if(a.Lang.isUndefined(r)){r=true;}t=a.one(t);var u=t.getAncestorByTagName("tr");if(a.FormManager.statusTakesPrecedence(this._getElementStatus(u,h),s)){if(!this.hasMessages&&r){a.one(u.get("firstChild")).scrollIntoView();}u.replaceClass(e,j+s);this.hasMessages=true;}var q=t.getAncestorByTagName("td");if(a.FormManager.statusTakesPrecedence(this._getElementStatus(q,k),s)){if(v){q.one("."+d.error_text_class).set("innerHTML",v);
}q.replaceClass(m,n+s);this.hasMessages=true;}},_getElementStatus:function(t,s){var q=t.get("className").match(s);return((q&&q.length)?q[1]:false);},_getColumnKey:function(r){var q=l.exec(r.get("className"));return q[1];}});a.namespace("Plugin");a.Plugin.DataTableQuickEdit=d;},"gallery-2011.08.24-23-44",{skinnable:true,optional:["gallery-scrollintoview"],requires:["datatable-base","gallery-formmgr-css-validation","gallery-node-optimizations","gallery-patch-340-datatable-formatter"]});