YUI.add("gallery-quickedit",function(d){d.Column.ATTRS.quickEdit={};d.Column.ATTRS.qeFormatter={validator:d.Lang.isFunction};function j(s){j.superclass.constructor.call(this,s);}j.NAME="QuickEditPlugin";j.NS="qe";j.ATTRS={changesAlwaysInclude:{value:[],validator:d.Lang.isArray}};var o="(?:^|\\s)(?:",a=")(?:\\s|$)",e=/quickedit-key:([^\s]+)/,c="quickedit-has",n=c+"([a-z]+)",f=new RegExp(o+n+a),g="quickedit-has",b=g+"([a-z]+)",m=new RegExp(o+b+a);j.status_order=["error","warn","success","info"];function i(s){for(var t=0;t<j.status_order.length;t++){if(s==j.status_order[t]){return t;}}return j.status_order.length;}function h(t,s){return(!t||i(s)<i(t));}j.error_text_class="quickedit-message-text";j.error_display_markup='<div class="quickedit-message-text"></div>';j.textFormatter=function(u){var s='<input type="text" class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+j.error_display_markup;var t=u.column.get("quickEdit");return d.Lang.sub(s,{key:u.column.get("key"),yiv:t.validation?(t.validation.css||""):"",value:u.value||u.value===0?u.value.toString().replace('"',""):""});};j.textareaFormatter=function(u){var s='<textarea class="{yiv} quickedit-field quickedit-key:{key}" value="{value}"/>'+j.error_display_markup;var t=u.column.get("quickEdit");return d.Lang.sub(s,{key:u.column.get("key"),yiv:t.validation?(t.validation.css||""):"",value:u.value||u.value===0?u.value.toString().replace('"',""):""});};j.readonlyEmailFormatter=function(s){return(s.value||"");};j.readonlyLinkFormatter=function(s){return(s.value||"");};function r(u,t){var w=null;this._tbodyNode.get("children").some(function(x){if(x.contains(u)){w=x;return true;}});if(!w){return null;}var s=u.getAncestorByTagName("td",true);var v=-1;w.get("children").some(function(y,x){if(y===s){v=x;return true;}});w=(t<0?w.previous():w.next());return w?w.get("children").item(v):null;}function p(v,s){var u=s.one(".quickedit-field");if(!u){return;}var t=d.Lang.trim(u.get("value"));if(!t&&t!==0){return;}while(1){s=r.call(this,s,+1);if(!s){break;}u=s.one(".quickedit-field");if(u){u.set("value",t);}}}j.copyDownFormatter=function(t){if(t.column.get("quickEdit").copyDown&&t.rowindex===0){var s=d.Node.create("<button></button>");s.set("title","Copy down");s.set("innerHTML","&darr;");t.td.insert(s,t.td.one("."+j.error_text_class));s.on("click",p,t.td,this);}};function k(t,s){return function(u){return(u.record?t:s).apply(this,arguments);};}function q(u){var s=r.call(this,u.target,u.charCode==38?-1:+1);if(s){var t=s.one(".quickedit-field");if(t){t.focus();t.select();u.halt(true);}}}function l(y){var B=this.get("host");var z=B.get("columnset").keyHash;var u=true;var w=y.size();for(var v=0;v<w;v++){var x=y.item(v);var t=z[this._getColumnKey(x)].get("quickEdit");if(!t){continue;}var A=t.validation?t.validation.msg:null;var s=d.FormManager.validateFromCSSData(x,A);if(s.error){this.displayMessage(x,s.error,"error");u=false;continue;}if(s.keepGoing){if(t.validation&&t.validation.regex instanceof RegExp&&!t.validation.regex.test(x.get("value"))){this.displayMessage(x,A?A.regex:null,"error");u=false;continue;}}if(t.validation&&d.Lang.isFunction(t.validation.fn)&&!t.validation.fn.call(B,x)){u=false;continue;}}return u;}d.extend(j,d.Plugin.Base,{initializer:function(s){this.hasMessages=false;},start:function(){this.fire("clearErrorNotification");var B=this.get("host");var y=B.get("columnset").keys;this.saveSort=[];this.saveEdit={};this.saveFmt={};for(var w=0;w<y.length;w++){var u=y[w];var A=u.get("key");this.saveSort.push(u.get("sortable"));u.set("sortable",false);var v=u.get("quickEdit");var C=u.get("qeFormatter");if(
/*!col.hidden &&*/
(v||C)){var z=null;if(v&&d.Lang.isFunction(v.formatter)){z=v.formatter;}else{if(d.Lang.isFunction(C)){z=C;}else{z=j.textFormatter;}}if(z){var x=u.get("formatter");var t=k.call(this,z,x);this.saveFmt[A]=x;u.set("formatter",t);}}}var s=B.get("contentBox");s.addClass(B.getClassName("quickedit"));this.move_event_handle=s.on("key",q,"down:38+ctrl,40+ctrl",B);B.syncUI();},cancel:function(){this.fire("clearErrorNotification");var v=this.get("host");var w=v.get("columnset").keys;for(var u=0;u<w.length;u++){var t=w[u];t.set("sortable",this.saveSort[u]);}delete this.saveSort;delete this.saveEdit;w=v.get("columnset").keyHash;d.Object.each(this.saveFmt,function(x,y){w[y].set("formatter",x);});delete this.saveFmt;var s=v.get("contentBox");s.removeClass(v.getClassName("quickedit"));if(this.move_event_handle){this.move_event_handle.detach();delete this.move_event_handle;}v.syncUI();},getChanges:function(){if(!this.validate()){return false;}var I=[];var w=this.get("changesAlwaysInclude");var C=this.get("host");var G=C.get("recordset");var x=C._tbodyNode.get("children");var A=x.size();var y=C.get("columnset").keyHash;for(var F=0;F<A;F++){var v=G.getRecord(F);var H=x.item(F).all(".quickedit-field");var z={};I.push(z);var B=H.size();for(var E=0;E<B;E++){var s=H.item(E);var K=this._getColumnKey(s);var t=y[K];var u=t.get("quickEdit");var D=v.getValue(K);var J=d.Lang.trim(s.get("value"));if(u.changed?u.changed(D,J):J!==(D?D.toString():"")){z[K]=J;}}for(var E=0;E<w.length;E++){var K=w[E];z[K]=v.getValue(K);}}return I;},validate:function(){this.clearMessages();var s=true;var t=this.get("host");var w=t._tbodyNode.getElementsByTagName("input");var v=t._tbodyNode.getElementsByTagName("textarea");var u=t._tbodyNode.getElementsByTagName("select");s=l.call(this,w)&&s;s=l.call(this,v)&&s;s=l.call(this,u)&&s;if(!s){this.fire("notifyErrors");}return s;},clearMessages:function(){this.hasMessages=false;this.fire("clearErrorNotification");var s=this.get("host");s._tbodyNode.getElementsByClassName(n).removeClass(n);s._tbodyNode.getElementsByClassName(b).removeClass(b);s._tbodyNode.all("."+j.error_text_class).set("innerHTML","");},displayMessage:function(v,x,u,t){if(d.Lang.isUndefined(t)){t=true;}v=d.one(v);var w=v.getAncestorByTagName("tr");if(h(this._getElementStatus(w,f),u)){if(!this.hasMessages&&t){d.one(w.get("firstChild")).scrollIntoView();}w.replaceClass(n,c+u);
this.hasMessages=true;}var s=v.getAncestorByTagName("td");if(h(this._getElementStatus(s,m),u)){if(x){s.one("."+j.error_text_class).set("innerHTML",x);}s.replaceClass(b,g+u);this.hasMessages=true;}},_getElementStatus:function(u,t){var s=u.get("className").match(t);return((s&&s.length)?s[1]:false);},_getColumnKey:function(t){var s=e.exec(t.get("className"));return s[1];}});d.namespace("Plugin");d.Plugin.DataTableQuickEdit=j;},"gallery-2011.06.15-19-18",{skinnable:true,optional:["gallery-scrollintoview"],requires:["datatable-base","gallery-formmgr-css-validation","gallery-node-optimizations"]});