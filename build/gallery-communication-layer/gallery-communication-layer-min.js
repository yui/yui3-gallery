YUI.add("gallery-communication-layer",function(c){var b="gallery-communication-layer ["+c.config.win.location.href+"]";function a(d){d=d||{};this._WIN=c.config.win;this._APPREADY="appready";this._BUFFER_TIMEOUT=d.bufferTimeout||10000;this._CALLBACK_TIMEOUT=d.callbackTimeout||10000;this._GUID=c.guid();this._proxyFor={};this._subscriptionFor={};this._PARENT_ORIGIN_ALIAS="parent";this._parentProxy=this._createEventProxy(this._PARENT_ORIGIN_ALIAS);if(d.debug){this._initDebugMode();}this._init();}a.prototype={_init:function(){this._initWindowMessageHandler();this._initParentConnection();},_initWindowMessageHandler:function(){this._addListener(this._WIN,"message",c.bind(function(i){var d,f,h;try{d=c.JSON.parse(i.data);}catch(g){}if(this._validateEventData(d)){h=this._createCLEventData(i,d);f=this._proxyRouter(i,d);if(f){f.fire(d.name,h);}}else{}},this));},_validateEventData:function(d){return !!(d&&d.name&&d.guid);},_proxyRouter:function(d,i){var g=i.name,f=i.guid,e=d.origin,h=null;if(this._proxyFor[g]){h=this._proxyFor[g];}else{if(this._proxyFor[f+e]){h=this._proxyFor[f+e];}else{}}return h;},_createCLEventData:function(d,e){var f={data:e.data,guid:e.guid,origin:d.origin,source:d.source};if(e.cbid){f.callback=c.bind(function(){this._postMessage(f.source,{name:e.cbid,guid:this._GUID,data:{args:c.Array(arguments)}},f.origin);},this);}return f;},_initParentConnection:function(){var e=this,g=e._WIN,d=g.location.href,f;if(g.parent==g){return;}if(d){f=e._getHandshakeToken(d);e._createEventProxy(f).once(f,function(h){e._deleteEventProxy(f);e._parentSource=h.source;e._parentOrigin=h.origin;e._parentGuid=h.guid;e._proxyFor[h.guid+h.origin]=e._parentProxy;e._parentProxy.fire(e._APPREADY);});e._postMessage(g.parent,{name:f,guid:e._GUID},"*");}},register:function(g,d){var e=this,h,f;g=c.one(g);h=g&&g.test("iframe")&&g.get("src");if(!h){return;}f=e._getHandshakeToken(h);e._createEventProxy(f).once(f,function(n){var i=n.origin,l=n.source,j=n.guid,k,m;if(c.Lang.isFunction(d)){k=e._createEventProxy(j+i);m=e._createCLProxy(k,{origin:i,source:l,guid:j});m.iframe=g;d(m);}e._deleteEventProxy(f);e._postMessage(l,{name:f,guid:e._GUID},i);});},_createCLProxy:function(g,i){var e=this,h=i.source,d=i.origin,f=i.guid;return{on:function(k,l){var j=c.Array(arguments);j.splice(1,1,function(m){if(d===m.origin){l(m);}});return g.on.apply(g,j);},once:function(k,l){var j=c.Array(arguments);j.splice(1,1,function(m){if(d===m.origin){l(m);}});return g.once.apply(g,j);},fire:function(k,l,j){e._fireWindowMessageEvent(k,h,d,{data:l,guid:f,callback:j});},open:function(k,j){return e._createConnectionObject(k,j,{guid:f,source:h,origin:d});},ready:function(j,k){return g.on(e._APPREADY,j,k);},purge:function(){if(!g){return;}c.Object.each(e._proxyFor,function(k,j){if(k===g){e._deleteEventProxy(j);}});g.detachAll();g=null;}};},ready:function(){this._fireParentMessageEvent(this._APPREADY);},on:function(e,f){var d=c.Array(arguments);d.unshift({once:false});return this._onParentMessageEvent.apply(this,d);},once:function(e,f){var d=c.Array(arguments);d.unshift({once:true});return this._onParentMessageEvent.apply(this,d);},fire:function(e,f,d){if(e){this._fireParentMessageEvent(e,f,d);}},open:function(e,d){if(this._parentAppIsReady()){return this._createConnectionObject(e,d,{guid:this._parentGuid,source:this._parentSource,origin:this._parentOrigin});}else{}},_createConnectionObject:function(g,d,i){var e=this,f,h;if(!(g&&c.Lang.isFunction(d)&&i.origin&&i.guid)){return null;}f=e._registerCallback(d,i.origin,i.guid,g);return{write:function(j){if(!e._subscriptionFor[g]){return;}e._fireWindowMessageEvent(g,i.source,i.origin,{data:j,guid:i.guid,callback:f});},close:function(){h=e._subscriptionFor[g];if(h){h.detach();delete e._subscriptionFor[g];}}};},_fireParentMessageEvent:function(f,i,d){var e=this,g,h;g=function(){e._fireWindowMessageEvent(f,e._parentSource,e._parentOrigin,{data:i,guid:e._parentGuid,callback:d});};if(!e._parentAppIsReady()){h=e._parentProxy.once(e._APPREADY,g);c.later(e._BUFFER_TIMEOUT,null,function(){if(!e._parentAppIsReady()){h.detach();}});}else{g();}},_parentAppIsReady:function(){var d=this._parentProxy.getEvent(this._APPREADY);return d.fired;},_getHandshakeToken:function(d){return d.replace(/[?].*$/,"").replace(/[#].*$/,"");},_registerCallback:function(g,l,j,e,k){var i=this._proxyFor[j+l],h=c.stamp(g),f,d;if(!i){return;}if(k){d=i.once(h,function(m){f.cancel();g.apply(null,m.data.args);});f=c.later(k,null,function(){d.detach();});}else{this._subscriptionFor[e]=i.on(h,function(m){g.apply(null,m.data.args);});}return h;},_createEventProxy:function(e){if(e){var d=new c.EventTarget();d.publish(this._APPREADY,{fireOnce:true});this._proxyFor[e]=d;return d;}},_deleteEventProxy:function(d){if(this._proxyFor[d]){this._proxyFor[d].detachAll();this._proxyFor[d]=null;}},_onParentMessageEvent:function(){var e=c.Array(arguments),d=e.shift(),g=d.once?"once":"on",f=this._parentProxy;return f[g].apply(f,e);},_fireWindowMessageEvent:function(f,g,e,i){var h,d;if(f&&g&&e){i=i||{};d=i.callback;h={name:f,guid:this._GUID};if(i.data){h.data=i.data;}if(c.Lang.isFunction(d)){h.cbid=this._registerCallback(d,e,i.guid,f,this._CALLBACK_TIMEOUT);}else{if(c.Lang.isString(d)){h.cbid=d;}}this._postMessage(g,h,e);}},_postMessage:function(e,f,d){if(e&&e.postMessage&&f&&d){e.postMessage(c.JSON.stringify(f),d);return true;}},_initDebugMode:function(){var d=this._createEventProxy("debug");YUI.CL={fire:function(e,f){d.fire(e,{data:f});},on:function(){return d.on.apply(d,arguments);},once:function(){return d.once.apply(d,arguments);}};c.Array.each(["fire","on","once"],function(e){var f=this[e];this[e]=function(){d[e].apply(d,arguments);f.apply(this,arguments);};},this);},_addListener:function(e,f,d){if(e.addEventListener){e.addEventListener(f,d,false);}else{if(e.attachEvent){e.attachEvent("on"+f,d);}else{e["on"+f]=d;}}},_removeListener:function(f,g,e){if(f.removeEventListener){try{f.removeEventListener(g,e);}catch(d){}}else{if(f&&f.detachEvent){f.detachEvent("on"+g,e);
}}}};c.CommunicationLayer=a;},"gallery-2012.07.05-20-01",{requires:["json","node-base","event-custom-base"],skinnable:false});